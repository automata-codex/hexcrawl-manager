name: Require Changeset

on:
  pull_request:
    branches: [ develop ]
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  require-changeset:
    # Optional bypass label for docs/chore PRs
    if: ${{ !contains(join(github.event.pull_request.labels.*.name, ' '), 'skip-changeset') }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files vs base
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          CHANGED="$(git diff --name-only --diff-filter=AMRT origin/${{ github.base_ref }}...HEAD)"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Skip if only non-code paths changed (adjust as needed)
        id: scope
        run: |
          if echo "${{ steps.diff.outputs.files }}" | grep -E '^(apps/|cli/|data/|lib/|packages/|schemas/|scripts/|src/)' >/dev/null; then
            echo "check=true" >> "$GITHUB_OUTPUT"
            echo "Detected code-path changes -> check=true"
          else
            echo "check=false" >> "$GITHUB_OUTPUT"
            echo "No code-path changes -> check=false"
          fi
        shell: bash
        continue-on-error: true

      - name: Enforce changeset for code changes
        if: steps.scope.outcome == 'success' && steps.scope.outputs.check != ''
        run: |
          # Count new/modified changeset markdown files in this PR
          git fetch origin ${{ github.base_ref }} --depth=1
          COUNT="$(git diff --name-only --diff-filter=AMR origin/${{ github.base_ref }}...HEAD -- .changeset/*.md 2>/dev/null | wc -l | xargs)"
          if [ "$COUNT" -eq 0 ]; then
            echo "::error title=Missing changeset::This PR changes code but adds no .changeset/*.md file."
            echo "Run:  pnpm changeset   (or yarn changeset / npx changeset)"
            exit 1
          fi
          echo "Changeset found âœ…"
