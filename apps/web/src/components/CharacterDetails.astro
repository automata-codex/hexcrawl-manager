---
import { getCollection, getEntry } from 'astro:content';

import { normalizeClueRef } from '@skyreach/schemas';
import type { CharacterData, PlayerData } from '@skyreach/schemas';

import { getCluePath } from '../config/routes';
import { renderMarkdown, renderSubArticleMarkdown } from '../utils/markdown';

interface Props {
  character: CharacterData;
  isSubcomponent?: boolean;
}

const { character, isSubcomponent = false } = Astro.props;

// Get player data
const playerData = await getEntry('players', character.playerId);
if (!playerData) {
  throw new Error(`Player not found: ${character.playerId}`);
}
const player: PlayerData = playerData.data;

// Get all clues and build ID-to-name map
const allClues = await getCollection('clues');
const clueNameMap = new Map(allClues.map((c) => [c.id, c.data.name]));

// Build clue links with validation
const clueLinks = (character.clues ?? []).map((ref) => {
  const normalized = normalizeClueRef(ref);
  return {
    id: normalized.id,
    name: clueNameMap.get(normalized.id) ?? normalized.id,
    context: normalized.context,
    isValid: clueNameMap.has(normalized.id),
  };
});

// Format subheadings
const subheading = (text: string) => {
  if (isSubcomponent) {
    return `<h3 class="title is-4">${text}</h3>`;
  }
  return `<h2 class="title is-3">${text}</h2>`;
};

// Format text
const backstoryTitle = character.backstoryTitle
  ? `Backstory: ${character.backstoryTitle}`
  : 'Backstory';

function getBackstoryText(markdown: string): Promise<string> {
  return isSubcomponent
    ? renderSubArticleMarkdown(markdown)
    : renderMarkdown(markdown);
}
---

<style is:global>
  p {
    text-indent: var(--skyreach-standard-indent);
  }

  p:first-child,
  h2 + p,
  h3 + p,
  h4 + p,
  h5 + p,
  h6 + p {
    text-indent: 0;
  }
</style>
<style>
  .data-container {
    display: flex;
  }

  .data-container > div {
    width: 50%;
  }
</style>
<div class="data-container">
  <div>
    <ul>
      <li>Name: {character.displayName}</li>
      <li>Pronouns: {character.pronouns}</li>
      <li>Species: {character.species}</li>
      <li>Culture: {character.culture}</li>
    </ul>
  </div>
  <div>
    <ul>
      <li>Player: {player.displayName} ({player.pronouns})</li>
      <li>Class: {character.class}</li>
      {character.subclass && <li>Subclass: {character.subclass}</li>}
      <li>Level: {character.level}</li>
    </ul>
  </div>
</div>
{
  character.backstory && (
    <div>
      <Fragment set:html={subheading(backstoryTitle)} />
      <Fragment set:html={getBackstoryText(character.backstory)} />
    </div>
  )
}
{
  character.goals && (
    <div>
      <Fragment set:html={subheading('Goals')} />
      <Fragment set:html={renderMarkdown(character.goals)} />
    </div>
  )
}
{
  character.notes && (
    <div>
      <Fragment set:html={subheading('Notes')} />
      <Fragment set:html={renderMarkdown(character.notes)} />
    </div>
  )
}
{
  clueLinks.length > 0 && (
    <div>
      <Fragment set:html={subheading('Clues')} />
      <ul>
        {clueLinks.map((link) => (
          <li>
            {link.isValid ? (
              <a href={getCluePath(link.id)}>{link.name}</a>
            ) : (
              <span>{link.id} (not found)</span>
            )}
            {link.context && <span> â€” {link.context}</span>}
          </li>
        ))}
      </ul>
    </div>
  )
}
