---
import { getCollection } from 'astro:content';

import { getEncounterPath } from '../config/routes';
import RandomEncounterTable from './RandomEncounterTable/RandomEncounterTable.astro';

import type { EncounterTableData, RegionData } from '@skyreach/schemas';

interface Props {
  region: RegionData;
  encounters?: EncounterTableData;
  encounterChance?: number;
  headingLevel?: 'h2' | 'h3';
}

const {
  region,
  encounters = region.encounters,
  encounterChance = region.encounterChance,
  headingLevel = 'h2',
} = Astro.props;

// Herald encounter logic
const allEncounters = await getCollection('encounters');
const heraldActive = !region.heraldComplete && (region.heraldEncounters?.length ?? 0) > 0;
const heraldEncounters = heraldActive
  ? (region.heraldEncounters ?? []).map((id) => {
      const encounter = allEncounters.find((e) => e.data.id === id)?.data;
      if (!encounter) {
        throw new Error(`Region "${region.id}" references unknown herald encounter: "${id}"`);
      }
      return encounter;
    })
  : [];

const HeadingTag = headingLevel;
---

<style>
  .encounters-header {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 0.75rem;
    margin-bottom: 0.25rem;
  }

  .encounters-header :global(.title) {
    margin-bottom: 0;
  }

  .herald-banner {
    background-color: #dcfce7;
    border: 1px solid #86efac;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    display: inline-block;
    margin-bottom: 0.25rem;
  }

  .herald-banner-text {
    font-weight: 600;
    color: #166534;
  }

  /* Dark mode - explicit theme */
  :global(html[data-theme='dark']) .herald-banner {
    background-color: #14532d;
    border-color: #166534;
  }

  :global(html[data-theme='dark']) .herald-banner-text {
    color: #86efac;
  }

  /* Dark mode - system preference when no explicit theme */
  @media (prefers-color-scheme: dark) {
    :global(html:not([data-theme])) .herald-banner {
      background-color: #14532d;
      border-color: #166534;
    }

    :global(html:not([data-theme])) .herald-banner-text {
      color: #86efac;
    }
  }

  .herald-encounter-list {
    list-style: disc;
    margin-left: 1.5rem;
  }

  .herald-complete-btn {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background-color: #166534;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .herald-complete-btn:hover {
    background-color: #14532d;
  }

  .herald-complete-btn:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
  }
</style>

<div class="encounters-header">
  <HeadingTag class="title is-3">Random Encounters</HeadingTag>
  {heraldActive && (
    <div class="herald-banner">
      <span class="herald-banner-text">Herald Phase Active</span>
    </div>
  )}
</div>
{heraldActive ? (
  <>
    <p class="hanging-indent">
      <span class="inline-heading">Chance of encounter:</span>
      {' '}
      50% (&le;10)
    </p>
    <p><strong>Herald Encounters:</strong></p>
    <ul class="herald-encounter-list">
      {heraldEncounters.map((encounter) => (
        <li>
          <a href={getEncounterPath(encounter.id)}>{encounter.name}</a>
        </li>
      ))}
    </ul>
    <button
      class="herald-complete-btn"
      data-region-id={region.id}
      id="herald-complete-btn"
    >
      Mark Herald Complete
    </button>
  </>
) : (
  <>
    <p class="hanging-indent">
      <span class="inline-heading">Chance of encounter:</span>
      {' '}
      {encounterChance * 5}% (&le;{encounterChance})
    </p>
    <RandomEncounterTable data={encounters} />
  </>
)}

<script>
  const btn = document.getElementById('herald-complete-btn');
  if (btn) {
    btn.addEventListener('click', async () => {
      const regionId = btn.getAttribute('data-region-id');
      if (!regionId) return;

      btn.setAttribute('disabled', 'true');
      btn.textContent = 'Completing...';

      try {
        const response = await fetch(`/api/regions/${regionId}/complete-herald`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const data = await response.json();
          alert(`Error: ${data.error || 'Failed to complete herald'}`);
          btn.removeAttribute('disabled');
          btn.textContent = 'Mark Herald Complete';
        }
      } catch (error) {
        alert('Network error. Please try again.');
        btn.removeAttribute('disabled');
        btn.textContent = 'Mark Herald Complete';
      }
    });
  }
</script>
