---
import type { DungeonEntry, HexEntry } from '../../types';
import type { RegionData } from '@achm/schemas';

interface Props {
  dungeons: DungeonEntry[];
  hexData: HexEntry[];
  hexCount: number;
  region: RegionData;
}

const { dungeons, hexData, hexCount, region } = Astro.props;

// Use region.hexes as the authoritative source of membership
const regionHexIds = new Set(
  (region.hexes ?? []).map((id) => id.toLowerCase()),
);

const contentDensityDescriptions = {
  1: 'Very Low (0.1–0.2 hidden sites/hex, 0–1 dungeons)',
  2: 'Low (0.2–0.3 hidden sites/hex, 1 dungeon)',
  3: 'Moderate (0.3–0.5 hidden sites/hex, 1–2 dungeons)',
  4: 'High (0.5–0.7 hidden sites/hex, 2–3 dungeons)',
  5: 'Very High (0.7–1.0+ hidden sites/hex, 3–5 dungeons)',
} as const;

const dungeonCount = dungeons.filter((dungeon) => {
  const hexId = dungeon.data.hexId?.toLowerCase();
  return hexId && regionHexIds.has(hexId);
}).length;

const hiddenSiteCount = hexData
  .filter((hex) => regionHexIds.has(hex.data.id.toLowerCase()))
  .reduce((acc, hex) => acc + (hex.data.hiddenSites?.length || 0), 0);

const hiddenSiteDensity = (hiddenSiteCount / hexCount).toFixed(2);
---

<p class="hanging-indent">
  <span class="inline-heading">Content Density:</span>{' '}
  {region.contentDensity} – {
    contentDensityDescriptions[region.contentDensity as 1 | 2 | 3 | 4 | 5]
  }
</p>
<p class="hanging-indent">
  <span class="inline-heading">Hidden site density:{' '}</span>
  {hiddenSiteDensity} per hex ({hiddenSiteCount} total)
</p>
<p class="hanging-indent">
  <span class="inline-heading">Number of dungeons:{' '}</span>
  {dungeonCount}
</p>
