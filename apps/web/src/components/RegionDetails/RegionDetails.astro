---
import { getCollection } from 'astro:content';

import { hexSort } from '@skyreach/core';
import { getEncounterPath, getHexPath, getRegionPath } from '../../config/routes';
import { renderMarkdown } from '../../utils/markdown';
import SecretContent from '../Content/SecretContent.astro';
import RandomEncounterTable from '../RandomEncounterTable/RandomEncounterTable.astro';

import ContentDensity from './ContentDensity.astro';
import TreasureRating from './TreasureRating.astro';

import type { RegionData } from '@skyreach/schemas';

interface Props {
  region: RegionData;
  isSubcomponent?: boolean;
}

const { region, isSubcomponent = false } = Astro.props;

function getHeading(text: string) {
  const element = isSubcomponent ? 'h3' : 'h2';
  return `<${element} class="title is-3" style="margin-bottom: 0.25rem">${text}</${element}>`;
}

const articles = await getCollection('articles');
const dungeons = await getCollection('dungeons');
const hexData = await getCollection('hexes');
const hexes = hexData
  .filter((hex) => hex.data.regionId === region.id)
  .map((hex) => hex.data.id.toUpperCase())
  .sort((a, b) => hexSort(a, b));

// Herald encounter logic
const allEncounters = await getCollection('encounters');
const heraldActive = !region.heraldComplete && (region.heraldEncounters?.length ?? 0) > 0;
const heraldEncounters = heraldActive
  ? (region.heraldEncounters ?? []).map((id) => {
      const encounter = allEncounters.find((e) => e.data.id === id)?.data;
      if (!encounter) {
        throw new Error(`Region "${region.id}" references unknown herald encounter: "${id}"`);
      }
      return encounter;
    })
  : [];
---

<style>
  .description-container {
    margin-top: 1rem;

    p:not(:first-child) {
      text-indent: var(--skyreach-standard-indent);
    }
  }

  .hex-list {
    display: flex;
    font-weight: bold;

    div {
      margin-right: 1rem;
    }
  }

  :global(.story-container p) {
    margin-top: 1rem;
  }

  :global(.story-container p:first-child) {
    margin-top: 0;
  }

  .encounters-header {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 0.75rem;
    margin-bottom: 0.25rem;
  }

  .encounters-header :global(.title) {
    margin-bottom: 0;
  }

  .herald-banner {
    background-color: #dcfce7;
    border: 1px solid #86efac;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    display: inline-block;
    margin-bottom: 0.5rem;
  }

  .herald-banner-text {
    font-weight: 600;
    color: #166534;
  }

  /* Dark mode - explicit theme */
  :global(html[data-theme='dark']) .herald-banner {
    background-color: #14532d;
    border-color: #166534;
  }

  :global(html[data-theme='dark']) .herald-banner-text {
    color: #86efac;
  }

  /* Dark mode - system preference when no explicit theme */
  @media (prefers-color-scheme: dark) {
    :global(html:not([data-theme])) .herald-banner {
      background-color: #14532d;
      border-color: #166534;
    }

    :global(html:not([data-theme])) .herald-banner-text {
      color: #86efac;
    }
  }

  .herald-encounter-list {
    list-style: disc;
    margin-left: 1.5rem;
  }

  .herald-complete-btn {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background-color: #166534;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .herald-complete-btn:hover {
    background-color: #14532d;
  }

  .herald-complete-btn:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
  }
</style>
<SecretContent>
  <div>
    <div class="hex-list">
      <div><span class="inline-heading">Hexes:</span></div>
      {
        hexes.map((hex) => (
          <div>
            <a href={getHexPath(hex.toLowerCase())}>{hex}</a>
          </div>
        ))
      }
      <div>|</div>
      <div><a href=`${getRegionPath(region.id)}/hexes`>View all</a></div>
    </div>
    {region.topography && (
      <div class="hanging-indent">
        <span class="inline-heading">Topography:</span>{' '}{region.topography}
      </div>
    )}
    <div class="hanging-indent">
      <span class="inline-heading">Haven:</span>{' '}{region.haven}
    </div>
    <ContentDensity
      dungeons={dungeons}
      hexData={hexData}
      hexCount={hexes.length}
      region={region}
    />
    <TreasureRating
      articles={articles}
      dungeons={dungeons}
      hexData={hexData}
      region={region}
    />
    <div class="description-container">
      <Fragment set:html={renderMarkdown(region.description)} />
    </div>
    {(region.story) && (
      <Fragment set:html={getHeading('Story')} />
      <div class="story-container">
        <Fragment set:html={renderMarkdown(region.story)} />
      </div>
    )}
    <div class="encounters-header">
      <Fragment set:html={getHeading('Random Encounters')} />
      {heraldActive && (
        <div class="herald-banner">
          <span class="herald-banner-text">Herald Phase Active</span>
        </div>
      )}
    </div>
    {heraldActive ? (
      <>
        <p class="hanging-indent">
          <span class="inline-heading">Chance of encounter:</span>
          {' '}
          50% (&le;10)
        </p>
        <p><strong>Herald Encounters:</strong></p>
        <ul class="herald-encounter-list">
          {heraldEncounters.map((encounter) => (
            <li>
              <a href={getEncounterPath(encounter.id)}>{encounter.name}</a>
            </li>
          ))}
        </ul>
        <button
          class="herald-complete-btn"
          data-region-id={region.id}
          id="herald-complete-btn"
        >
          Mark Herald Complete
        </button>
      </>
    ) : (
      <>
        <p class="hanging-indent">
          <span class="inline-heading">Chance of encounter:</span>
          {' '}
          {region.encounterChance * 5}% (&le;{region.encounterChance})
        </p>
        <RandomEncounterTable data={region.encounters} />
      </>
    )}
  </div>
</SecretContent>

<script>
  const btn = document.getElementById('herald-complete-btn');
  if (btn) {
    btn.addEventListener('click', async () => {
      const regionId = btn.getAttribute('data-region-id');
      if (!regionId) return;

      btn.setAttribute('disabled', 'true');
      btn.textContent = 'Completing...';

      try {
        const response = await fetch(`/api/regions/${regionId}/complete-herald`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const data = await response.json();
          alert(`Error: ${data.error || 'Failed to complete herald'}`);
          btn.removeAttribute('disabled');
          btn.textContent = 'Mark Herald Complete';
        }
      } catch (error) {
        alert('Network error. Please try again.');
        btn.removeAttribute('disabled');
        btn.textContent = 'Mark Herald Complete';
      }
    });
  }
</script>
