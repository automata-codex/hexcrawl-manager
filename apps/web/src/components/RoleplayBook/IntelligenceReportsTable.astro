---
import type { IntelligenceReportRow, LinkType } from '@skyreach/schemas';
import {
  getDungeonPath,
  getEncounterPath,
  getFloatingCluePath,
  getHexPath,
  getRegionPath,
} from '../../config/routes';
import { renderMarkdown } from '../../utils/markdown';

interface Props {
  instructions?: string;
  rows: IntelligenceReportRow[];
}

const { instructions, rows } = Astro.props;

/**
 * Generate the URL path for a link based on its type and ID.
 */
function getLinkPath(linkType: LinkType, linkId: string): string {
  switch (linkType) {
    case 'encounter':
      return getEncounterPath(linkId);
    case 'dungeon':
      return getDungeonPath(linkId);
    case 'clue':
      return getFloatingCluePath(linkId);
    case 'hex':
      return getHexPath(linkId);
    case 'region':
      return getRegionPath(linkId);
    case 'faction':
      return `/gm-reference/factions#${linkId}`;
    case 'knowledge-node':
      return `/gm-reference/knowledge-trees/${linkId}`;
    default:
      return '#';
  }
}

/**
 * Generate display text for a link based on its type and ID.
 * Formats the type nicely and uses the ID as the label.
 */
function getLinkText(linkType: LinkType, linkId: string): string {
  const typeLabels: Record<LinkType, string> = {
    'clue': 'Clue',
    'dungeon': 'Dungeon',
    'encounter': 'Encounter',
    'faction': 'Faction',
    'hex': 'Hex',
    'knowledge-node': 'Knowledge',
    'region': 'Region',
  };

  // Format the ID nicely (convert kebab-case to Title Case)
  const formattedId = linkId
    .split('-')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');

  return `${typeLabels[linkType]}: ${formattedId}`;
}
---

<style>
  .intelligence-reports {
    margin-top: 2rem;
  }

  .instructions {
    font-style: italic;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background-color: var(--bulma-scheme-main-bis);
    border-left: 3px solid var(--bulma-link-text);
  }

  .reports-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }

  .reports-table th {
    background-color: var(--bulma-scheme-main-ter);
    border: 1px solid var(--bulma-border);
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
  }

  .reports-table td {
    border: 1px solid var(--bulma-border);
    padding: 0.75rem;
    vertical-align: top;
  }

  .reports-table tbody tr:nth-child(even) {
    background-color: var(--bulma-scheme-main-bis);
  }

  .reports-table tbody tr:hover {
    background-color: var(--bulma-scheme-main-ter);
  }

  .roll-column {
    width: 5%;
    text-align: center;
    font-weight: 600;
  }

  .report-column {
    width: 25%;
  }

  .dialogue-column {
    width: 40%;
    font-style: italic;
  }

  .conditions-column {
    width: 30%;
  }
</style>

<div class="intelligence-reports">
  <h2 class="title is-4">Intelligence Reports</h2>

  {instructions && (
    <div class="instructions">
      {instructions}
    </div>
  )}

  <table class="reports-table">
    <thead>
      <tr>
        <th class="roll-column">Roll</th>
        <th class="report-column">Report</th>
        <th class="dialogue-column">Sample Dialogue</th>
        <th class="conditions-column">Relevant Conditions</th>
      </tr>
    </thead>
    <tbody>
      {rows.map((row) => (
        <tr>
          <td class="roll-column">{row.roll}</td>
          <td class="report-column">
            {row.linkType && row.linkId ? (
              <>{row.report} â†’ <a href={getLinkPath(row.linkType, row.linkId)}>{getLinkText(row.linkType, row.linkId)}</a></>
            ) : (
              row.report
            )}
          </td>
          <td class="dialogue-column">
            <Fragment set:html={renderMarkdown(row.sampleDialogue)} />
          </td>
          <td class="conditions-column">
            <Fragment set:html={renderMarkdown(row.relevantConditions)} />
          </td>
        </tr>
      ))}
    </tbody>
  </table>
</div>
