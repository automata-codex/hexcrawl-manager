---
import { getCollection, getEntry, render, type CollectionEntry } from 'astro:content';

import SecretContent from '../components/Content/SecretContent.astro';
import ArticleLayout from '../layouts/ArticleLayout.astro';
import SecretArticleLayout from '../layouts/SecretArticleLayout.astro';

const currentPath = Astro.url.pathname;

// 1. Try composite articles first (by slug)
const composites = await getCollection('composite-articles');
const composite = composites.find((c) => c.data.slug === currentPath);

type RenderedContent = Awaited<ReturnType<typeof render>>['Content'];
type SectionData = {
  Content: RenderedContent;
  secure: boolean;
  heading?: string;
};

let isComposite = false;
let compositeTitle = '';
let compositeSections: SectionData[] = [];

if (composite) {
  isComposite = true;
  compositeTitle = composite.data.title;
  compositeSections = await Promise.all(
    composite.data.sections.map(async (section) => {
      const article = await getEntry('articles', section.articleId);
      if (!article) {
        throw new Error(
          `Composite "${composite.data.id}" references unknown article: ${section.articleId}`,
        );
      }
      const { Content } = await render(article);
      return {
        Content,
        secure: section.secure,
        heading: section.heading,
      };
    }),
  );
}

// 2. Try simple articles (by slug) - only if not a composite
let SimpleContent: RenderedContent | null = null;
let isSecure = false;
let title = '';

if (!isComposite) {
  const articles = await getCollection('articles');
  const article = articles.find((a) => a.data.slug === currentPath);

  if (!article) {
    return new Response(null, {
      status: 404,
      statusText: 'Not found',
    });
  }

  const rendered = await render(article);
  SimpleContent = rendered.Content;
  isSecure = article.data.secure ?? false;
  title = article.data.title;
}
---

{
  isComposite ? (
    <ArticleLayout title={compositeTitle}>
      <article>
        {compositeSections.map(({ Content: SectionContent, secure, heading }) =>
          secure ? (
            <SecretContent>
              {heading && <h2 class="title is-3">{heading}</h2>}
              <SectionContent />
            </SecretContent>
          ) : (
            <div>
              {heading && <h2 class="title is-3">{heading}</h2>}
              <SectionContent />
            </div>
          ),
        )}
      </article>
    </ArticleLayout>
  ) : isSecure ? (
    <SecretArticleLayout title={title}>
      <article>
        {SimpleContent && <SimpleContent />}
      </article>
    </SecretArticleLayout>
  ) : (
    <ArticleLayout title={title}>
      <article>
        {SimpleContent && <SimpleContent />}
      </article>
    </ArticleLayout>
  )
}
