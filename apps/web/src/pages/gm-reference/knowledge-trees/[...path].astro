---
import { getCollection } from 'astro:content';

import KnowledgeNodePage from '../../../components/KnowledgeNodePage.astro';
import SecretLayout from '../../../layouts/SecretLayout.astro';
import {
  buildPlacementMap,
  getFlatKnowledgeTree,
  getKnowledgeTree,
  getNodeFromTree,
} from '../../../utils/knowledge-trees';

const { path } = Astro.params;
if (!path) {
  return Astro.redirect('/gm-reference/knowledge-trees');
}

const segments = path.split('/');
const treeId = segments[0];
const nodeKey = segments.join('.');

const tree = await getKnowledgeTree(treeId);
if (!tree) {
  throw new Error(`Unknown knowledge tree: ${treeId}`);
}

// Get flat tree for breadcrumb name lookup
const flatTree = await getFlatKnowledgeTree(treeId);
if (!flatTree) {
  throw new Error(`Could not flatten tree: ${treeId}`);
}

// Get full node from tree (with children intact)
const node = getNodeFromTree(tree, segments);
if (!node) {
  throw new Error(`Unknown node: ${nodeKey} in tree ${treeId}`);
}

// Build breadcrumb data
const breadcrumbs = segments.map((_, index) => {
  const key = segments.slice(0, index + 1).join('.');
  const breadcrumbNode = flatTree[key];
  return {
    key,
    name: breadcrumbNode?.name ?? key,
    path: `/gm-reference/knowledge-trees/${segments.slice(0, index + 1).join('/')}`,
  };
});

// Build placement map
const hexEntries = await getCollection('hexes');
const hexes = hexEntries
  .map((entry) => entry.data)
  .filter((hex) => !hex.hideInCatalog);
const dungeonEntries = await getCollection('dungeons');
const dungeons = dungeonEntries.map((entry) => entry.data);
const floatingClueEntries = await getCollection('floatingClues');
const floatingClues = floatingClueEntries.map((entry) => entry.data);
const pointcrawlNodeEntries = await getCollection('pointcrawl-nodes');
const pointcrawlNodes = pointcrawlNodeEntries.map((entry) => entry.data);
const encounterEntries = await getCollection('encounters');
const encounters = encounterEntries.map((entry) => entry.data);

const placementMap = buildPlacementMap(
  hexes,
  dungeons,
  floatingClues,
  pointcrawlNodes,
  encounters,
);

const placements = placementMap[nodeKey] ?? [];
---

<SecretLayout title={`Knowledge: ${node.name}`}>
  <KnowledgeNodePage
    node={node}
    nodeKey={nodeKey}
    treeId={treeId}
    tree={tree}
    breadcrumbs={breadcrumbs}
    placements={placements}
  />
</SecretLayout>
