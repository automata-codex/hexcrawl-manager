---
import { getCollection } from 'astro:content';

import SecretContent from '../../components/Content/SecretContent.astro';
import SessionDetails from '../../components/SessionDetails/SessionDetails.astro';
import ComponentLayout from '../../layouts/ComponentLayout.astro';

const sessionData = await getCollection('sessions');
const sessions = sessionData
  .map((s) => s.data)
  .sort(
    (a, b) =>
      new Date(b.sessionDate).getTime() - new Date(a.sessionDate).getTime(),
  );

/**
 * Get a Date object for the session date plus 24 hours
 */
function revealTime(sessionDate: string): Date {
  const match = sessionDate.match(/^(\d{4})-(\d{2})-(\d{2})$/);

  if (match) {
    const [, year, month, day] = match.map(Number); // Convert to numbers
    return new Date(year, month - 1, day + 1);
  } else {
    throw new Error(`Invalid date format: ${sessionDate}`);
  }
}
---

<ComponentLayout title="Sessions">
  {
    sessions.map((session) => {
      const sessionDate = revealTime(session.sessionDate);
      const today = new Date();
      if (sessionDate.getTime() > today.getTime()) {
        return (
          <SecretContent>
            <SessionDetails session={session} />
          </SecretContent>
        );
      }
      return <SessionDetails session={session} />;
    })
  }
</ComponentLayout>
