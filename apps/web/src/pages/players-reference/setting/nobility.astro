---
import { getCollection } from 'astro:content';
import SecretContent from '../../../components/Content/SecretContent.astro';
import NobilityChart from '../../../components/NobilityChart.svelte';
import NobleHierarchy from '../../../components/NobleHierarchy.astro';
import ArticleLayout from '../../../layouts/ArticleLayout.astro';
import OpenContent from '../../../components/Content/OpenContent.astro';

// Fetch all nobles
const noblesCollection = await getCollection('nobles');
const nobles = noblesCollection.map((entry) => entry.data);

// Fetch political factions
const factionsCollection = await getCollection('political-factions');
const factions = factionsCollection.map((entry) => entry.data);

// Separate public and secret factions
const publicFactions = factions.filter((f) => !f.secret);
const secretFactions = factions.filter((f) => f.secret);

// Helper to get faction members
function getFactionMembers(factionId: string) {
  return nobles.filter((n) => n.factions?.includes(factionId));
}

// Helper to get noble by ID
function getNoble(id: string) {
  return nobles.find((n) => n.id === id);
}

// Get root nobles (those with no liege), sorted by sortValue
const rootNobles = nobles
  .filter((n) => n.liege === null)
  .sort((a, b) => (a.sortValue ?? a.id).localeCompare(b.sortValue ?? b.id));
const publicRoots = rootNobles.filter((n) => !n.secret);
const allRoots = rootNobles;
---

<ArticleLayout title="Vaulridge Nobility">
  <article>
    <!-- Public view (players see this) -->
    <OpenContent>
      <NobilityChart nobles={nobles} showSecrets={false} client:load />
    </OpenContent>

    <SecretContent>
      <NobilityChart nobles={nobles} showSecrets={true} client:load />
    </SecretContent>

    <h2 class="title is-3">Nobles of Vaulridge</h2>

    <OpenContent>
      <ul class="hierarchy-list">
        {publicRoots.map((root) => (
          <NobleHierarchy noble={root} allNobles={nobles} showSecrets={false} />
        ))}
      </ul>
    </OpenContent>

    <SecretContent>
      <ul class="hierarchy-list">
        {allRoots.map((root) => (
          <NobleHierarchy noble={root} allNobles={nobles} showSecrets={true} />
        ))}
      </ul>
    </SecretContent>

    <h2 class="title is-3">Political Factions</h2>

    {publicFactions.map((faction) => (
      <div class="faction-section">
        <h3 class="title is-4">{faction.name}</h3>
        {faction.description && <p>{faction.description}</p>}

        {faction.leadership && faction.leadership.length > 0 && (
          <>
            <h4 class="title is-5">Leadership</h4>
            <ul>
              {faction.leadership.map((leaderId) => {
                const leader = getNoble(leaderId);
                return leader ? (
                  <li>
                    <span class="inline-heading">{leader.displayTitle ?? leader.name}</span>
                    {leader.description && <>: {leader.description}</>}
                  </li>
                ) : null;
              })}
            </ul>
          </>
        )}

        <SecretContent>
          {faction.gmNotes && <p><strong>GM Notes:</strong> {faction.gmNotes}</p>}
        </SecretContent>
      </div>
    ))}

    <SecretContent>
      <h2 class="title is-3">Secret Factions</h2>

      {secretFactions.map((faction) => (
        <div class="faction-section">
          <h3 class="title is-4">{faction.name}</h3>
          {faction.description && <p set:html={faction.description.replace(/\n/g, '<br>')} />}
          {faction.gmNotes && <p><strong>GM Notes:</strong> {faction.gmNotes}</p>}

          {faction.leadership && faction.leadership.length > 0 && (
            <>
              <h4 class="title is-5">Leadership</h4>
              <ul>
                {faction.leadership.map((leaderId) => {
                  const leader = getNoble(leaderId);
                  return leader ? (
                    <li>
                      <span class="inline-heading">{leader.displayTitle ?? leader.name}:</span>
                      {' '}{leader.description}
                      {leader.gmNotes && <> {leader.gmNotes}</>}
                    </li>
                  ) : null;
                })}
              </ul>
            </>
          )}

          {(() => {
            const members = getFactionMembers(faction.id).filter(
              (n) => !faction.leadership?.includes(n.id)
            );
            return members.length > 0 ? (
              <>
                <h4 class="title is-5">Members</h4>
                <ul>
                  {members.map((member) => (
                    <li>
                      <span class="inline-heading">{member.displayTitle ?? member.name}</span>
                      {member.gmNotes && <>: {member.gmNotes}</>}
                    </li>
                  ))}
                </ul>
              </>
            ) : null;
          })()}
        </div>
      ))}
    </SecretContent>
  </article>
</ArticleLayout>

<style>
  .faction-section {
    margin-bottom: 1.5rem;
  }
</style>
