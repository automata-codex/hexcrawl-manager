---
import { getCollection, getEntry } from 'astro:content';

import type { EncounterData } from '@achm/schemas';

import Clue from '../../../components/Clue.astro';
import SecretArticleLayout from '../../../layouts/SecretArticleLayout.astro';
import { buildClueUsageMap, getClueUsage } from '../../../utils/clue-usage-tracker';

// Get the ID from the incoming server request
const { id } = Astro.params;
if (!id) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

// Query for the entry directly using the request slug
const clueData = await getEntry('clues', id);

// Redirect if the entry does not exist
if (clueData === undefined) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

// Load collections needed for usage tracking
const [encounters, hexes, dungeons, pointcrawlNodes, characters, npcs, plotlines, roleplayBooks, clues] = await Promise.all([
  getCollection('encounters'),
  getCollection('hexes'),
  getCollection('dungeons'),
  getCollection('pointcrawl-nodes'),
  getCollection('characters'),
  getCollection('npcs'),
  getCollection('plotlines'),
  getCollection('roleplay-books'),
  getCollection('clues'),
]);

// Build encounter map for resolving keyed encounter references
const encounterMap = new Map<string, EncounterData>();
for (const encounter of encounters) {
  encounterMap.set(encounter.id, encounter.data);
}

// Build usage map and get usages for this clue
const usageMap = buildClueUsageMap(
  encounters,
  hexes,
  dungeons,
  pointcrawlNodes,
  encounterMap,
  characters,
  npcs,
  plotlines,
  roleplayBooks,
  clues,
);
const usedIn = getClueUsage(usageMap, id);

const clue = clueData.data;
const title = `Clue: ${clue.name}`;
---

<style is:global>
  h3.title.is-4 {
    margin-bottom: 0.25rem;
  }
</style>
<SecretArticleLayout title={title}>
  <Clue clue={clue} usedIn={usedIn} />
</SecretArticleLayout>
