---
import { loadMapConfig } from '@achm/data';
import { getCollection } from 'astro:content';

import HexSearch from '../../../components/GmHexDetails/HexSearch.svelte';
import SecretLayout from '../../../layouts/SecretLayout.astro';
import { hexSort, processHex } from '../../../utils/hexes';

import type { ExtendedHexData, PointcrawlLink, ResolvedHexData } from '../../../types';

const notation = loadMapConfig().grid.notation;

const dungeons = await getCollection('dungeons');
const hexEntries = await getCollection('hexes');
const intermediateHexes = hexEntries
  .map((entry) => entry.data as ResolvedHexData)
  .sort((a, b) => hexSort(a, b, notation))
  .filter((hex) => !hex.hideInCatalog);
const hexes: ExtendedHexData[] = await Promise.all(
  intermediateHexes.map(processHex),
);

// Build map of hexId -> pointcrawls for that hex
const allPointcrawls = await getCollection('pointcrawls');
const pointcrawlsByHex: Record<string, PointcrawlLink[]> = {};
for (const pc of allPointcrawls) {
  for (const hexId of pc.data.hexIds ?? []) {
    if (!pointcrawlsByHex[hexId]) {
      pointcrawlsByHex[hexId] = [];
    }
    pointcrawlsByHex[hexId].push({ slug: pc.data.slug, name: pc.data.name });
  }
}
---

<SecretLayout title="Hex Catalog">
  <HexSearch
    client:load
    dungeons={dungeons}
    hexes={hexes}
    pointcrawlsByHex={pointcrawlsByHex}
  />
</SecretLayout>
