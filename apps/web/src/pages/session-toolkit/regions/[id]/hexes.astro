---
import { normalizeHexId } from '@achm/core';
import { loadMapConfig } from '@achm/data';
import { getCollection } from 'astro:content';

import GmHexDetails from '../../../../components/GmHexDetails/GmHexDetails.svelte';
import SecretLayout from '../../../../layouts/SecretLayout.astro';
import { createSyntheticHex, hexSort, processHex, resolveHexWithRegion } from '../../../../utils/hexes';
import { getRegionShortTitle } from '../../../../utils/regions';

import type { ExtendedHexData } from '../../../../types';

const { id: regionId } = Astro.params;
if (!regionId) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

const mapConfig = loadMapConfig();
const notation = mapConfig.grid.notation;

const dungeons = await getCollection('dungeons');
const hexEntries = await getCollection('hexes');
const regions = await getCollection('regions');

// Find the region
const region = regions.find((r) => r.id === regionId);
if (!region) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

// Build a map of hex files by normalized ID
const hexFileMap = new Map(
  hexEntries.map((e) => [normalizeHexId(e.data.id, notation), e.data]),
);

// Get hex data for each hex in the region (file-based or synthetic)
const regionHexIds = region.data.hexes ?? [];
const allHexData = regionHexIds.map((hexId) => {
  const normalizedId = normalizeHexId(hexId, notation);
  const fileData = hexFileMap.get(normalizedId);
  return fileData ?? createSyntheticHex(normalizedId, region.data);
});

const resolvedHexes = allHexData
  .filter((hex) => !hex.hideInCatalog)
  .sort((a, b) => hexSort(a, b, notation))
  .map((hex) => resolveHexWithRegion(hex, region));

const hexes: ExtendedHexData[] = await Promise.all(
  resolvedHexes.map(processHex),
);
---

<SecretLayout title={`${getRegionShortTitle(regionId, region.data.name)} Hexes`}>
  {
    hexes.map((hex) => (
      <>
        <h2 class="title is-3">
          {hex.id.toUpperCase()}: {hex.name}
        </h2>
        <GmHexDetails
          client:load
          dungeons={dungeons}
          hex={hex}
        />
      </>
    ))
  }
</SecretLayout>
