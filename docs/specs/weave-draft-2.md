# `weave` CLI ‚Äî v1 Spec

## Purpose

Safely apply session log files to your YAML-based campaign state.

* **YAML files** (`/state/*.yaml`) are the authoritative source of truth.
* **Session files** (`/sessions/*.yaml`) contain patch-like changes from play.
* **`weave`** applies them with guardrails:

  * Prevent double-application (session guard).
  * Preserve manual edits (optimistic merge).
  * Refuse to apply with uncommitted changes (commit hook).

## Session File Structure

```yaml
id: S19-1511-Autumn
worldTime:
  start: "1511-09-14T08:00"
  end:   "1511-09-14T20:00"
irlTime: "2025-09-14T21:12-04:00"   # optional provenance
seq: 0                              # optional tie-breaker
changes:
  - path: "state/status.yaml#currentHex"
    value: "P14"

  - path: "state/trails.yaml#trails[edge=P13-P14].usedThisSeason"
    value: true

  - path: "state/trails.yaml#trails[edge=P13-P14].streak"
    expectedOld: 1
    value: 2

  - op: remove
    path: "state/trails.yaml#trails[edge=O12-O13]"
    expectedOld:
      edge: [O12, O13]
```

* **`id`**: unique label.
* **`worldTime`**: in-world start/end; used for ordering unapplied sessions.
* **`irlTime`**: when the session was played.
* **`seq`**: tie-breaker if two sessions start at the same in-world time.
* **`changes`**: patch list.

  * Default `op` is `set` (idempotent set/upsert).
  * `expectedOld` enables optimistic merge (skip if mismatch).
  * `op: remove` deletes an array element by keyed selector.

## Ledger (`/state/meta.yaml`)

```yaml
appliedSessions:
  - S19-1511-Autumn
sessionFootprints:
  S19-1511-Autumn:
    trails:
      "P13-P14.usedThisSeason": false
      "P13-P14.streak": 1
```

* **`appliedSessions`**: prevents accidental re-apply.
* **`sessionFootprints`**: records prior values for optimistic merge.

## Commands

### `weave apply [<session.yaml>] [--force] [--allow-dirty]`

Apply the next unapplied session (or specified one).

1. **Commit hook**

  * If git working tree dirty ‚Üí abort.
  * `--allow-dirty` bypasses.

2. **Session guard**

  * If `id` already in `appliedSessions` and no `--force` ‚Üí abort.

3. **Apply changes**

  * Resolve `path`.
  * If `expectedOld` present and current ‚â† expected ‚Üí **skip + warn**.
  * Else set/upsert/remove deterministically.

4. **Update ledger**

  * Add session `id` to `appliedSessions`.
  * Record a footprint (previous values for applied changes).

5. **Exit codes**

  * `0` success (‚â•1 change applied).
  * `5` no-op (all skipped).
  * `2` repo dirty (without `--allow-dirty`).
  * `3` session already applied (without `--force`).
  * `4` validation/type error.

**Default session selection**:

* If no `<session.yaml>` provided:

  * Load `/sessions/*.yaml`.
  * Filter out applied IDs.
  * Sort by (`worldTime.start`, then `seq`, then filename).
  * Pick the oldest unapplied.

### `weave plan [<session.yaml>]`

Show what would change, without touching files.

* Same discovery and validation as `apply`.
* Never writes files or ledger.
* Output:

  * ‚úÖ apply (from ‚Üí to)
  * üîí skipped (expectedOld mismatch)
  * ‚ûï upsert (new record)
  * ‚ùå remove (element deleted)
* Exit codes:

  * `0` plan generated.
  * `3` session already applied (warn; show what would happen with `--force`).
  * `4` validation/type error.
  * `6` no unapplied sessions found.

### `weave status`

* Report:

  * Git cleanliness.
  * Last N applied sessions.
  * Pending unapplied sessions (ordered by worldTime).

## Season Rollovers

* Rollover should be generated by a separate `scribe rollover` command, which outputs a normal session file (`ROLL-1512-Win.yaml`).
* `weave` just applies it like any other session.
* If a season flips mid-session, split into `Sxxa.yaml`, `ROLL-‚Ä¶yaml`, and `Sxxb.yaml`.
* No separate season cursor is needed.
