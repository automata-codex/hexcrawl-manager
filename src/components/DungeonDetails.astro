---
import { getCollection, getEntry } from 'astro:content';
import { renderBulletMarkdown, renderMarkdown, renderSubArticleMarkdown } from '../utils/markdown';
import type { DungeonEntry } from '../types';
import StatBlock from './StatBlock/StatBlock.astro';

interface Props {
  dungeon: DungeonEntry;
  isSubcomponent?: boolean;
}

const { dungeon, isSubcomponent = false } = Astro.props;
const hexData = await getEntry('hexes', dungeon.data.hexId);
if (!hexData) {
  throw new Error('Hex not found: ' + dungeon.data.hexId);
}

const body = isSubcomponent ? dungeon.data.summary ?? dungeon.body : dungeon.body;
const content = isSubcomponent ? await renderSubArticleMarkdown(body ?? '') : await renderMarkdown(body ?? '');

const statBlockData = await getCollection('statBlocks');

async function getStatBlocks(statBlockIds: string[]) {
  const output = statBlockIds.map(async (id) => {
    const statBlock = statBlockData.find((statBlock) => statBlock.id === id);
    if (!statBlock) {
      throw new Error('Stat block not found: ' + id);
    }
    return statBlock.data;
  });
  return Promise.all(output);
}

const statBlocks = dungeon.data.statBlocks ? await getStatBlocks(dungeon.data.statBlocks) : [];
---
<style>
    .description-header {
        display: none;
    }

    .dungeon-data-bar {
        display: flex;
    }

    .dungeon-data-bar > div {
        font-weight: bold;
        margin-right: 1rem;
    }

    .dungeon-source {
        font-weight: bold;
    }

    .maps {
        font-weight: bold;
    }

    .spacer {
        margin-bottom: 0.5rem;
    }
</style>
<div class="dungeon-data-bar">
  <div>
    Hex:
    <a href={`/hexes/${hexData.id}`}>
      {renderBulletMarkdown(`${hexData.data.id.toUpperCase()} "${hexData.data.name}"`)}
    </a>
  </div>
  {isSubcomponent && (
    <div>
      <a href={`/dungeons/${dungeon.id}`}>
        View Dungeon
      </a>
    </div>
  )}
</div>
{dungeon.data.source && (
  <div class="dungeon-source">
    Source: <Fragment set:html={renderBulletMarkdown(dungeon.data.source)} />
  </div>
)}
{dungeon.data.images && (
    <div>
      <p class="maps">Maps:</p>
      <ul>
        {dungeon.data.images.map((image) => (
          <li>
            <a
              href={`/images/maps/dungeons/${image.filename}`}
              target="_blank"
              rel="noopener noreferrer"
            >
              {image.description}
            </a>
          </li>
        ))}
      </ul>
    </div>
  )}
<div class="spacer"></div>
<h2 class="description-header">Description</h2>
<Fragment set:html={content} />
{!isSubcomponent && statBlocks && (
  <div>
    <h2 class="title is-3">Stat Blocks</h2>
    {statBlocks.map((statBlock) => (
      <StatBlock data={statBlock} />
    ))}
  </div>
)}
