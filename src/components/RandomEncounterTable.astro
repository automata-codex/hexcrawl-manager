---
import { getCollection } from 'astro:content';
import type { RandomEncounterTableData } from '../types';
import { getEncounterPath } from '../utils/routes';

interface Props {
  data: RandomEncounterTableData;
}

if (Astro.props.data.length === 0) {
  return null;
}

const encounters = await getCollection('encounters');
type Encounter = typeof encounters[0];

const data = Astro.props.data
  .filter((encounter) => !encounter.isHidden)
  .sort((a, b) => a.range[0] - b.range[0])
  .map((encounter) => {
    let description = '';
    if ('text' in encounter.description) {
      description = encounter.description.text;
    } else if ('encounter' in encounter.description) {
      const encounterId = encounter.description.encounter;
      const encounterData = encounters.find((e: Encounter) => e.id === encounterId);
      if (encounterData) {
        description = `<a href="${getEncounterPath(encounterData.id)}">${encounterData.data.name}</a>`;
      } else {
        throw new Error('Encounter not found: ' + encounter.description.encounter);
      }
    } else {
      throw new Error ('Illegal encounter object:' + JSON.stringify(encounter));
    }
    return {
      ...encounter,
      description,
    };
  });

---
<style>
  table {
    border-spacing: 0;
    margin-top: 1rem;
  }
  td, th {
    border-bottom: 1px solid var(--bulma-border);
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
  }
  th {
    border-top: 1px solid var(--bulma-border);
  }

  .col-1 {
    padding-right: 1rem;
    padding-left: 1rem;
    text-align: center;
  }
  .col-2 {
    padding-right: 1rem;
    text-align: left;
  }
</style>
<table>
  <thead>
    <tr>
      <th class="col-1">d20</th>
      <th class="col-2">Description</th>
    </tr>
  </thead>
  <tbody>
    {data.map((encounter) => (
      <tr>
        <td class="col-1">
          <Fragment set:html={encounter.range.join('&ndash;')} />
        </td>
        <td class="col-2">
          <Fragment set:html={encounter.description} />
        </td>
      </tr>
    ))}
  </tbody>
</table>
