---
import { getCollection } from 'astro:content';

import type { RegionData } from '../types';
import { renderMarkdown } from '../utils/markdown';
import { getHexPath, getRegionPath } from '../utils/routes';

import SecretContent from './Content/SecretContent.astro';
import RandomEncounterTable from './RandomEncounterTable/RandomEncounterTable.astro';

interface Props {
  region: RegionData;
  isSubcomponent?: boolean;
}

const allRarities = [
  'common',
  'uncommon',
  'rare',
  'very rare',
  'legendary',
  'artifact',
] as const;
type Rarity = (typeof allRarities)[number];

type RarityCounts = Record<Rarity, number>;
// Initialize with 0s to ensure all keys are present
const initialRarityCounts: RarityCounts = Object.fromEntries(
  allRarities.map(r => [r, 0])
) as RarityCounts;

const { region, isSubcomponent = false } = Astro.props;

const contentDensityDescriptions = {
  1: 'Very Low (0.1–0.2 hidden sites/hex, 0–1 dungeons)',
  2: 'Low (0.2–0.3 hidden sites/hex, 1 dungeon)',
  3: 'Moderate (0.3–0.5 hidden sites/hex, 1–2 dungeons)',
  4: 'High (0.5–0.7 hidden sites/hex, 2–3 dungeons)',
  5: 'Very High (0.7–1.0+ hidden sites/hex, 3–5 dungeons)',
};

const treasureRatingDescriptions = {
  1: 'Very Low (250–500 gp, no or 1 consumable item)',
  2: 'Low (500–1,000 gp, 1–2 common items)',
  3: 'Moderate (1,000–2,000 gp, 2–3 uncommon items)',
  4: 'High (2,000–4,000 gp, 3–5 items, including rare)',
  5: 'Very High (4,000+ gp, multiple rare or very rare items)',
};

function getRecHeading() {
  const element = isSubcomponent ? 'h3' : 'h2';
  return `<${element} class="title is-3" style="margin-bottom: 0.25rem">Random Encounters</${element}>`;
}

const hexData = await getCollection('hexes');
const hexes = hexData
  .filter(hex => hex.data.regionId === region.id)
  .map(hex => hex.data.id.toUpperCase())
  .sort((a, b) => a.localeCompare(b));

const hiddenSiteCount = hexData
  .filter(hex => hex.data.regionId === region.id)
  .reduce((acc, hex) => acc + (hex.data.hiddenSites?.length || 0), 0);
const hiddenSiteDensity = (hiddenSiteCount / hexes.length).toFixed(2);
const hiddenSiteItems = hexData
  .filter(hex => hex.data.regionId === region.id)
  .flatMap(hex => hex.data.hiddenSites || [])
  .flatMap(site => typeof site !== 'string' && Array.isArray(site.magicItems) ? site.magicItems : [])
  .filter(item => typeof item === 'object' && item.rarity)
  .reduce((acc, item) => {
    acc[item.rarity] = (acc[item.rarity] || 0) + 1;
    return acc;
  }, { ...initialRarityCounts });
const hiddenSiteTreasure = hexData
  .filter(hex => hex.data.regionId === region.id)
  .flatMap(hex => hex.data.hiddenSites || [])
  .reduce((total, site) => total + ((typeof site !== 'string' && site.treasureValue) || 0), 0);

const dungeons = await getCollection('dungeons');
const dungeonCount = dungeons.filter(dungeon => {
  const hex = hexData.find(hex => hex.data.id === dungeon.data.hexId);
  return hex && hex.data.regionId === region.id;
}).length;
const dungeonItems = dungeons
  .filter(dungeon => {
    const hex = hexData.find(hex => hex.data.id === dungeon.data.hexId);
    return hex && hex.data.regionId === region.id;
  })
  .flatMap(dungeon => Array.isArray(dungeon.data.magicItems) ? dungeon.data.magicItems : [])
  .filter(item => typeof item === 'object' && item.rarity)
  .reduce((acc, item) => {
    acc[item.rarity] = (acc[item.rarity] || 0) + 1;
    return acc;
  }, { ...initialRarityCounts });
const dungeonTreasure = dungeons
  .filter(dungeon => {
    const hex = hexData.find(hex => hex.data.id === dungeon.data.hexId);
    return hex && hex.data.regionId === region.id;
  })
  .reduce((total, dungeon) => total + (dungeon.data.treasureValue || 0), 0);

const totalItemCounts = allRarities.reduce((acc, rarity) => {
  acc[rarity] = (hiddenSiteItems[rarity] || 0) + (dungeonItems[rarity] || 0);
  return acc;
}, { ...initialRarityCounts });
const totalTreasureValue = hiddenSiteTreasure + dungeonTreasure;
---
<style>
    .description-container {
        margin-top: 1rem;

        p:not(:first-child) {
            text-indent: var(--skyreach-standard-indent);
        }
    }

    .hex-list {
        display: flex;
        font-weight: bold;

        div {
            margin-right: 1rem;
        }
    }
</style>
<SecretContent>
  <div>
    <div class="hex-list">
      <div><span class="inline-heading">Hexes:</span></div>
      {hexes.map(hex => (
        <div>
          <a href={getHexPath(hex.toLowerCase())}>{hex}</a>
        </div>
      ))}
      <div>|</div>
      <div><a href=`${getRegionPath(region.id)}/hexes`>View all</a></div>
    </div>
    <div class="hanging-indent"><span class="inline-heading">Haven:</span>{' '}{region.haven}</div>
    <p class="hanging-indent">
      <span class="inline-heading">Content Density:</span>{' '}
      {region.contentDensity} – {contentDensityDescriptions[region.contentDensity as 1 | 2 | 3 | 4 | 5]}
    </p>
    <p class="hanging-indent">
      <span class="inline-heading">Treasure Rating:</span>{' '}
      {region.treasureRating} – {treasureRatingDescriptions[region.treasureRating as 1 | 2 | 3 | 4 | 5]}
    </p>
    <p class="hanging-indent">
      <span class="inline-heading">Number of dungeons:{' '}</span>
      {dungeonCount}
    </p>
    <p class="hanging-indent">
      <span class="inline-heading">Hidden site density:{' '}</span>
      {hiddenSiteDensity} per hex ({hiddenSiteCount} total)
    </p>
    <p class="hanging-indent">
      <span class="inline-heading">Total treasure value:</span>{' '}
      {totalTreasureValue} gp
    </p>
    <p class="hanging-indent">
      <span class="inline-heading">Magic items:</span>{' '}
      {Object.entries(totalItemCounts)
        .filter(([_, count]) => count > 0)
        .map(([rarity, count]) => `${count} ${rarity}`)
        .join(', ')}
    </p>
    <div class="description-container">
      <Fragment set:html={renderMarkdown(region.description)} />
    </div>
    <Fragment set:html={getRecHeading()} />
    <p class="hanging-indent">
      <span class="inline-heading">Chance of encounter:</span>
      {' '}
      {region.encounterChance * 5}%
      (&le;{region.encounterChance})
    </p>
    <RandomEncounterTable data={region.encounters} />
  </div>
</SecretContent>
