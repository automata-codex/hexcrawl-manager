---
import { getEntry } from 'astro:content';
import SecretArticleLayout from '../../layouts/SecretArticleLayout.astro';
import DungeonDetails from '../../components/DungeonDetails.astro';
import type { DungeonEntry } from '../../types';

// Get the ID from the incoming server request
const { id } = Astro.params;
if (!id) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

// Query for the entry directly using the request slug
const dungeon = await getEntry('dungeons', id);

// Redirect if the entry does not exist
if (dungeon === undefined) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

const title = `Dungeon: ${dungeon.data.name}`;

function getImageFileName(dungeon: DungeonEntry): string|null {
  if (dungeon.data.images) {
    // Otherwise, find the first entry in the dungeon.data.images array with `display` set to true. If there isn't one, just return the first element in the array.
    const firstImage = dungeon.data.images.find((image) => image.display === true) || dungeon.data.images[0];
    return firstImage.filename;
  }

  return null;
}

const image = getImageFileName(dungeon);
---
<SecretArticleLayout title={title}>
  {image && <img src={`/images/maps/dungeons/${image}`} alt={title} />}
  <DungeonDetails dungeon={dungeon} />
</SecretArticleLayout>
