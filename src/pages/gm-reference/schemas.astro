---
import { promises as fs } from 'node:fs';
import { resolve } from 'path';
import { fileURLToPath } from 'url';
import type { ZodTypeAny } from 'zod';

import SecretLayout from '../../layouts/SecretLayout.astro';
import { flattenZodSchema } from '../../utils/schemas';

const __dirname = fileURLToPath(new URL('.', import.meta.url));
const SCHEMA_DIR = resolve(__dirname, '../../../schemas');

// Load all Zod schemas dynamically
async function loadZodSchemas() {
  const filenames = await fs.readdir(SCHEMA_DIR);
  const schemas = [];

  for (const filename of filenames) {
    if (filename.endsWith('.js') || filename.endsWith('.ts')) {
      const modulePath = '../../../schemas/' + filename.replace(/\.(js|ts)$/, '');
      const schemaModule = await import( /* @vite-ignore */ modulePath);

      // Heuristic: pick the last exported item that ends with 'Schema'
      const schemaEntry = [...Object.entries(schemaModule)]
        .reverse()
        .find(([key]) => key.endsWith('Schema'));

      if (schemaEntry) {
        const [name, schema] = schemaEntry;
        const fields = flattenZodSchema(schema as ZodTypeAny);
        schemas.push({ name, fields });
      }
    }
  }

  return schemas;
}

const schemaList = await loadZodSchemas();
---
<style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 2rem;
    }

    th, td {
        text-align: left;
        border-bottom: 1px solid #333;
        padding-right: 1rem;
    }
</style>

<SecretLayout title="Game Master Reference: Schemas">
  {
    schemaList.map(({ name, fields }) => (
      <section>
        <h2 class="title is-4"><code>{name}</code></h2>
        <table>
          <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Required</th>
            <th>Description</th>
          </tr>
          </thead>
          <tbody>
          {fields.map(field => (
            <tr>
              <td>
                <span style={`padding-left: ${field.depth}rem; display: inline-block;`}>
                  {field.depth > 0 && '└ '}
                  {field.key.split('.').pop()}
                </span>
              </td>
              <td>{field.type}</td>
              <td>{field.required ? '✓' : ''}</td>
              <td>{field.description}</td>
            </tr>
          ))}
          </tbody>
        </table>
      </section>
    ))
  }
</SecretLayout>
