---
import { promises as fs } from 'node:fs';
import { resolve } from 'path';
import { fileURLToPath } from 'url';
import SecretLayout from '../../layouts/SecretLayout.astro';

// Convert import.meta.url into a real filesystem path
const __dirname = fileURLToPath(new URL('.', import.meta.url));
const SCHEMA_DIR = resolve(__dirname, '../../../schemas');

// Utility function to load all JSON schema files
async function loadSchemas() {
  const filenames = await fs.readdir(resolve(import.meta.url, SCHEMA_DIR));
  const schemas = [];

  for (const filename of filenames) {
    if (filename.endsWith('.json')) {
      const file = await fs.readFile(resolve(import.meta.url, SCHEMA_DIR, filename), 'utf-8');
      const parsed = JSON.parse(file);
      schemas.push({
        filename,
        schema: parsed,
      });
    }
  }

  return schemas;
}

const schemas = await loadSchemas();
---
<style>
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2rem;
  }

  th, td {
    padding: 0.5rem;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  th {
  }
</style>
<SecretLayout title="Game Master Reference: Schemas">
  {
    schemas.map(({ filename, schema }) => (
      <section>
        <h2 class="title is-4">{filename.replace('.json', '')}</h2>
        <table>
          <thead>
          <tr>
            <th>Field</th>
            <th>Type</th>
            <th>Required</th>
            <th>Description</th>
          </tr>
          </thead>
          <tbody>
          {/* Assume it's a JSON Schema "properties" structure */}
          {Object.entries(schema.properties ?? {}).map(([ key, value ]) => (
            <tr>
              <td>{key}</td>
              <td>{value.type || 'unknown'}</td>
              <td>{(schema.required ?? []).includes(key) ? 'Yes' : 'No'}</td>
              <td>{value.description || ''}</td>
            </tr>
          ))}
          </tbody>
        </table>
      </section>
    ))
  }
</SecretLayout>
