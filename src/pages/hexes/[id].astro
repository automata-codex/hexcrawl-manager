---
import { getCollection } from 'astro:content';

import Hex from '../../components/HexData/HexData.astro';
import RandomEncounterTable from '../../components/RandomEncounterTable.astro';
import Layout from '../../layouts/Layout.astro';
import type { HexData, RandomEncounterTableData } from '../../types';

export async function getStaticPaths() {
  const hexes = await getCollection('hexes');
  return hexes.map(hex => ({
    params: { id: hex.id },
    props: { hex: hex },
  }));
}

const hex: HexData = Astro.props.hex.data;
const title = `Hex ${hex.id.toUpperCase()}: ${hex.name}`;

// Build the random encounter table
let encounters: RandomEncounterTableData = [];
const regions = await getCollection('regions');
const region = regions.find(region => region.id === hex.regionId);
if (!region) {
  throw new Error('Region not found: ' + hex.regionId);
}
const parentEncounters = region.data.encounters;

// Merge two arrays of encounters, with the hex's encounters taking precedence
encounters = parentEncounters.map(parentEncounter => {
  const hexEncounter = hex.encounters?.find(hexEncounter => hexEncounter.id === parentEncounter.id);
  return hexEncounter || parentEncounter;
});
---
<Layout title={title}>
  <section class="section">
    <div class="container is-max-desktop">
      <h1 class="title is-2">{title}</h1>
      <Hex hex={hex} hideSelfLink={true} />
      <h2 class="title is-4" style="margin-bottom: 0.25rem">Random Encounters</h2>
      <p>
        <span class="inline-heading">Chance of encounter:</span>
        {' '}
        {region.data.encounterChance * 5}%
        (&le;{region.data.encounterChance})
      </p>
      <RandomEncounterTable data={encounters} />
    </div>
  </section>
</Layout>
