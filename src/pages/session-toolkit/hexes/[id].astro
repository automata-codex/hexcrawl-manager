---
import { getCollection, getEntry } from 'astro:content';

import GmHexDetails from '../../../components/HexData/GmHexDetails.astro';
import PlayerHexDetails from '../../../components/HexData/PlayerHexDetails.astro';
import RandomEncounterTable from '../../../components/RandomEncounterTable.astro';
import OpenContent from '../../../components/Content/OpenContent.astro';
import SecretContent from '../../../components/Content/SecretContent.astro';
import ComponentLayout from '../../../layouts/ComponentLayout.astro';
import type { HexData, RandomEncounterTableData } from '../../../types';

// Get the ID from the incoming server request
const { id } = Astro.params;
if (!id) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

// Query for the entry directly using the request slug
const hexData = await getEntry('hexes', id);

// Redirect if the entry does not exist
if (hexData === undefined) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

const hex: HexData = hexData.data;
const title = `Hex ${hex.id.toUpperCase()}: ${hex.name}`;

// Build the random encounter table
let encounters: RandomEncounterTableData = [];
const regions = await getCollection('regions');
const region = regions.find(region => region.id === hex.regionId);
if (!region) {
  throw new Error('Region not found: ' + hex.regionId);
}
const parentEncounters = region.data.encounters;

// Merge two arrays of encounters, with the hex's encounters taking precedence
encounters = parentEncounters.map(parentEncounter => {
  const hexEncounter = hex.encounters?.find(hexEncounter => hexEncounter.id === parentEncounter.id);
  return hexEncounter || parentEncounter;
});
---
<ComponentLayout title={title}>
  <OpenContent>
    <PlayerHexDetails hex={hex} />
  </OpenContent>
  <SecretContent>
    <GmHexDetails hex={hex} showSelfLink={false} />
    <h2 class="title is-4" style="margin-bottom: 0.25rem">Random Encounters</h2>
    <p>
      <span class="inline-heading">Chance of encounter:</span>
      {' '}
      {region.data.encounterChance * 5}%
      (&le;{region.data.encounterChance})
    </p>
    <RandomEncounterTable data={encounters} />
  </SecretContent>
</ComponentLayout>
