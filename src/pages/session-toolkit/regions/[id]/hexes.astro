---
import { getCollection } from 'astro:content';
import GmHexDetails from '../../../../components/HexDetails/GmHexDetails.svelte';
import SecretLayout from '../../../../layouts/SecretLayout.astro';
import type { ExtendedHexData } from '../../../../types';
import { processHex } from '../../../../utils/hexes';
import { getRegionTitle } from '../../../../utils/id-parsers';
import { getHexEntriesForRegion } from '../../../../utils/region-hex-mapper';
import { hexSort } from '../../../../utils/sort';

const { id: regionId } = Astro.params;
if (!regionId) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found'
  });
}

const dungeons = await getCollection('dungeons');

const allHexes = await getHexEntriesForRegion(regionId)
const intermediateHexes = allHexes
  .filter(hex => !!hex)
  .map((entry) => entry.data)
  .filter((hex) => !hex.hideInCatalog)
  .sort(hexSort);
const hexes: ExtendedHexData[] = await Promise.all(
  intermediateHexes.map(processHex)
);
---
<SecretLayout title={`${getRegionTitle(regionId)} Hexes`}>
  {hexes.map((hex) => (
    <h2 class="title is-3">{hex.id.toUpperCase()}: {hex.name}</h2>
    <GmHexDetails dungeons={dungeons} hex={hex} />
  ))}
</SecretLayout>
